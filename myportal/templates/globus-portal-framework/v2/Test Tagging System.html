<!DOCTYPE html>
<html lang="en">

{% extends "globus-portal-framework/v2/base.html" %}
{% load static %}

{% block headextras %}
  <link rel="stylesheet" type="text/css" href="{% static 'css/search.css' %}" />
  <link rel="stylesheet" href="{% static 'css/styles.css' %}">
{% endblock %}

{% block body %}
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>File Upload and Visualization</title>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <style>
        body,
        html {
            height: 100%;
            margin: 0;
            font-family: Arial, sans-serif;
            font-size: 16px;
        }

        .main-container {
            display: flex;
            max-width: 1400px;
            margin: auto;
            padding: 1rem;
            gap: 1rem;
        }

        .tagging-section {
            flex: 0 0 40%;
            background-color: #f4f4f4;
            padding: 15px;
            overflow-y: auto;
            border-right: 2px solid #ccc;
            max-height: 90vh;
        }

        .file-section {
            flex: 1;
            padding: 15px;
            overflow-x: hidden;
            min-width: 0;
        }

        .section {
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 0.75rem;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .section h4 {
            margin: 0;
            padding: 12px 15px;
            font-weight: bold;
            background-color: #e9ecef;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.95rem;
            user-select: none;
        }

        .section h4:hover {
            background-color: #dee2e6;
        }

        .section h4::after {
            content: '▼';
            font-size: 0.8em;
            transition: transform 0.3s;
        }

        .section.collapsed h4::after {
            transform: rotate(-90deg);
        }

        .section-content {
            padding: 12px;
            max-height: 300px;
            overflow-y: auto;
        }

        .section.collapsed .section-content {
            display: none;
        }

        .section label {
            display: block;
            padding: 3px 0;
            font-size: 0.9rem;
        }

        .file-tree-container {
            border: 1px solid #ccc;
            border-radius: 5px;
            background-color: #fff;
            padding: 10px;
            max-height: 600px;
            overflow-y: auto;
        }

        .file-input-label {
            display: block;
            background-color: #007bff;
            color: white;
            padding: 10px;
            text-align: center;
            border-radius: 5px;
            cursor: pointer;
            margin-bottom: 1rem;
        }

        .file-input-label.disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }

        .file-tree ul {
            list-style-type: none;
            padding-left: 20px;
        }

        .file-tree li {
            margin: 5px 0;
            display: block;
            background-color: #f8f9fa;
            cursor: pointer;
            padding: 8px;
            border-radius: 5px;
            max-width: 100%;
        }

        .file-name {
            flex: 0 1 auto;
            min-width: 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 300px;
        }

        .file-tree li.selected {
            border: 2px solid blue;
            background-color: #e7f3ff;
        }

        .file-icon {
            margin-right: 5px;
        }

        .file-icon.tagged {
            color: green;
        }

        .file-icon.untagged {
            color: red;
        }

        .file-tag {
            margin-left: 10px;
            font-size: 0.9em;
            color: #555;
        }

        .tag {
            display: inline-block;
            padding: 2px 6px;
            font-size: 0.8em;
            margin: 2px;
            border-radius: 4px;
            color: white;
        }

        .thrust-tag {
            background-color: #007bff;
        }

        .pi-tag {
            background-color: #28a745;
        }

        .topic-tag {
            background-color: #17a2b8;
        }

        .data-tag {
            background-color: #ffc107;
        }

        .data-type-tag {
            background-color: #dc3545;
        }

        .document-type-tag {
            background-color: #6c757d;
        }

        .abstract-tag, .link-tag {
            background-color: #6610f2;
        }

        .tag:hover::after {
            content: attr(data-content);
            position: absolute;
            left: 100%;
            top: 0;
            white-space: nowrap;
            background-color: #333;
            color: #fff;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.8em;
            z-index: 1;
        }

        .untagged-items-container {
            border: 1px solid #ccc;
            margin-top: 20px;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 8px;
        }

        .untagged-items-container h4 {
            margin-bottom: 10px;
        }

        #untagged-items-list {
            list-style-type: none;
            padding: 0;
            max-height: 200px;
            overflow-y: auto;
        }

        #untagged-items-list li {
            margin: 5px 0;
            color: #555;
        }

        #creator-display {
            display: inline-block;
            margin-left: 20px;
            background-color: #007bff;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
        }

        .no-select {
            user-select: none;
            -moz-user-select: none;
            -webkit-user-select: none;
            -ms-user-select: none;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #2196F3;
        }

        input:focus + .slider {
            box-shadow: 0 0 1px #2196F3;
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        #abstract-description,
        #outer-link,
        #globus-path {
            width: 100%;
            min-height: 40px;
            padding: 8px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        .action-buttons {
            margin-top: 15px;
        }

        .btn {
            margin: 0.5rem 0;
        }

        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
            }

            .tagging-section {
                flex: 1;
                border-right: none;
                border-bottom: 2px solid #ccc;
                max-height: none;
            }

            .file-tree-container {
                max-height: 400px;
            }
        }
    </style>
</head>

<body>
    <div class="main-container">
        <div class="tagging-section">
            <div class="section">
                <h4>(Step 1) Creator</h4>
                <div class="section-content">
                    <input type="text" id="creator-name" class="form-control" placeholder="Enter creator name">
                    <button id="confirm-creator" class="btn btn-primary btn-block mt-2">Confirm</button>
                </div>
            </div>

            <h3 style="font-size: 1.1rem; margin: 15px 0 10px 0;">(Step 3) Tagging</h3>
            <div style="margin-bottom: 10px; padding: 10px; background: #fff; border-radius: 5px;">
                <label style="cursor: pointer;">
                    <input type="checkbox" id="subfolder-file-cover" />
                    <strong>Apply to Subfolders & Files</strong>
                </label>
            </div>
            
            <div class="section">
                <h4>Thrust (select 1 only)</h4>
                <div class="section-content" id="thrust-tags">
                    <label><input type="checkbox" name="thrust-tag" value="Thrust 1"> Thrust 1</label>
                    <label><input type="checkbox" name="thrust-tag" value="Thrust 2"> Thrust 2</label>
                    <label><input type="checkbox" name="thrust-tag" value="Thrust 3"> Thrust 3</label>
                    <label><input type="checkbox" name="thrust-tag" value="Thrust 4"> Thrust 4</label>
                    <label><input type="checkbox" name="thrust-tag" value="Thrust 5"> Thrust 5</label>
                    <label><input type="checkbox" name="thrust-tag" value="General"> General</label>
                    <label><input type="checkbox" name="thrust-tag" value="Publication Records"> Publication Records</label>
                </div>
            </div>

            <div class="section collapsed">
                <h4>PI Affiliated</h4>
                <div class="section-content" id="pi-tags">
                    <label><input type="checkbox" name="pi-tag" value="Junhong Chen"> Junhong Chen</label>
                    <label><input type="checkbox" name="pi-tag" value="Yuxin Chen"> Yuxin Chen</label>
                    <label><input type="checkbox" name="pi-tag" value="Elizabeth Ainsworth"> Elizabeth Ainsworth</label>
                    <label><input type="checkbox" name="pi-tag" value="Santanu Chaudhuri"> Santanu Chaudhuri</label>
                    <label><input type="checkbox" name="pi-tag" value="Mark Hersam"> Mark Hersam</label>
                    <label><input type="checkbox" name="pi-tag" value="Stuart Rowan"> Stuart Rowan</label>
                    <label><input type="checkbox" name="pi-tag" value="Wei Chen"> Wei Chen</label>
                    <label><input type="checkbox" name="pi-tag" value="Jonathan Claussen"> Jonathan Claussen</label>
                    <label><input type="checkbox" name="pi-tag" value="Jennifer Dunn"> Jennifer Dunn</label>
                    <label><input type="checkbox" name="pi-tag" value="Dokyoung Lee"> Dokyoung Lee</label>
                    <label><input type="checkbox" name="pi-tag" value="Zhiyong Cai"> Zhiyong Cai</label>
                    <label><input type="checkbox" name="pi-tag" value="Others"> Others</label>
                    <input type="text" id="pi-other" class="form-control mt-2" style="display:none;" placeholder="Enter other PI">
                </div>
            </div>

            <div class="section collapsed">
                <h4>Related Topic</h4>
                <div class="section-content" id="topic-tags">
                    <label><input type="checkbox" name="topic-tag" value="Printing"> Printing</label>
                    <label><input type="checkbox" name="topic-tag" value="FET sensors"> FET sensors</label>
                    <label><input type="checkbox" name="topic-tag" value="Lithium Ion Batteries"> Lithium Ion Batteries</label>
                    <label><input type="checkbox" name="topic-tag" value="Plant Growth"> Plant Growth</label>
                    <label><input type="checkbox" name="topic-tag" value="Crop Science"> Crop Science</label>
                    <label><input type="checkbox" name="topic-tag" value="Biochemistry"> Biochemistry</label>
                    <label><input type="checkbox" name="topic-tag" value="DFT Simulation"> DFT Simulation</label>
                    <label><input type="checkbox" name="topic-tag" value="MD Simulation"> MD Simulation</label>
                    <label><input type="checkbox" name="topic-tag" value="Functional Nanomaterial Synthesis"> Functional Nanomaterial Synthesis</label>
                    <label><input type="checkbox" name="topic-tag" value="Ink Formulation"> Ink Formulation</label>
                    <label><input type="checkbox" name="topic-tag" value="Cheimcal Engieerning"> Cheimcal Engieerning</label>
                    <label><input type="checkbox" name="topic-tag" value="Machine Learning"> Machine Learning</label>
                    <label><input type="checkbox" name="topic-tag" value="Manufacturing"> Manufacturing</label>
                    <label><input type="checkbox" name="topic-tag" value="Policy"> Policy</label>
                    <label><input type="checkbox" name="topic-tag" value="Data Analytics"> Data Analytics</label>
                    <label><input type="checkbox" name="topic-tag" value="TEA/LCA/MFA"> TEA/LCA/MFA</label>
                    <label><input type="checkbox" name="topic-tag" value="Others"> Others</label>
                    <input type="text" id="topic-other" class="form-control mt-2" style="display:none;" placeholder="Enter other topic">
                </div>
            </div>

            <div class="section collapsed">
                <h4>Data Tags</h4>
                <div class="section-content" id="data-tags">
                    <label><input type="checkbox" name="data-tag" value="Experimental Exploration"> Experimental</label>
                    <label><input type="checkbox" name="data-tag" value="Theoretical Simulation"> Theoretical</label>
                    <label><input type="checkbox" name="data-tag" value="Exploration Results"> Exploration Results</label>
                    <label><input type="checkbox" name="data-tag" value="Code Repository"> Code Repository</label>
                    <label><input type="checkbox" name="data-tag" value="Raw Experimental Data"> Raw Experimental Data</label>
                    <label><input type="checkbox" name="data-tag" value="Meeting Records"> Meeting Records</label>
                    <label><input type="checkbox" name="data-tag" value="Adminstrative Files"> Adminstrative Files</label>
                    <label><input type="checkbox" name="data-tag" value="Material Characterization"> Material Characterization</label>
                    <label><input type="checkbox" name="data-tag" value="Literatures"> Literatures</label>
                    <label><input type="checkbox" name="data-tag" value="Others"> Others</label>
                    <input type="text" id="data-tag-other" class="form-control mt-2" style="display:none;" placeholder="Enter other data tag">
                </div>
            </div>

            <div class="section collapsed">
                <h4>Data Type</h4>
                <div class="section-content" id="data-type-tags">
                    <label><input type="checkbox" name="data-type-tag" value="Dataset"> Dataset</label>
                    <label><input type="checkbox" name="data-type-tag" value="Records"> Records</label>
                    <label><input type="checkbox" name="data-type-tag" value="Publication"> Publication</label>
                    <label><input type="checkbox" name="data-type-tag" value="Experiment Results"> Experiment Results</label>
                    <label><input type="checkbox" name="data-type-tag" value="Images"> Images</label>
                    <label><input type="checkbox" name="data-type-tag" value="Videos"> Videos</label>
                    <label><input type="checkbox" name="data-type-tag" value="Code Scripts"> Code Scripts</label>
                    <label><input type="checkbox" name="data-type-tag" value="Computation Results"> Computation Results</label>
                    <label><input type="checkbox" name="data-type-tag" value="Machine Learning Model Files"> Machine Learning Model Files</label>
                    <label><input type="checkbox" name="data-type-tag" value="Others"> Others</label>
                    <input type="text" id="data-type-other" class="form-control mt-2" style="display:none;" placeholder="Enter other data type">
                </div>
            </div>

            <div class="section collapsed">
                <h4>Abstract Description</h4>
                <div class="section-content">
                    <textarea id="abstract-description" class="form-control" placeholder="Enter abstract description" rows="3"></textarea>
                </div>
            </div>

            <div class="section collapsed">
                <h4>Outer Link</h4>
                <div class="section-content">
                    <input type="text" id="outer-link" class="form-control" placeholder="Enter outer link">
                </div>
            </div>

            <button id="apply-tag" class="btn btn-primary btn-block mb-2">Apply Tag</button>
            <div class="action-buttons" style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px;">
                <button id="clear-all" class="btn btn-sm btn-secondary">Start Over</button>
                <button id="clear-selected-tags" class="btn btn-sm btn-secondary">Clear Selected</button>
                <button id="clear-tags" class="btn btn-sm btn-secondary">Clear All Tags</button>
                <button id="deselect-all" class="btn btn-sm btn-secondary">Deselect All</button>
            </div>
        </div>

        <div class="file-section">
            <div id="file-drop-zone" style="border: 2px dashed #007bff; border-radius: 8px; padding: 20px; text-align: center; background-color: #f8f9fa; margin-bottom: 1rem;">
                <p style="margin: 0; color: #6c757d;">
                    <i class="fas fa-cloud-upload-alt" style="font-size: 2em; color: #007bff;"></i><br>
                    <strong>Drag and drop files or folders here</strong><br>
                    <span style="font-size: 0.9em;">You can add multiple files/folders - they accumulate!</span><br>
                    <span style="font-size: 0.9em;">or</span>
                </p>
                <label for="file-input" class="file-input-label btn btn-primary disabled" id="file-input-label" style="margin-top: 10px;">(Step 2) Click to Select Folder</label>
                <div id="file-count" style="margin-top: 10px; color: #28a745; font-weight: bold; display: none;">
                    <i class="fas fa-check-circle"></i> <span id="file-count-text">0 files loaded</span>
                    <button id="remove-all-files" class="btn btn-danger btn-sm" style="margin-left: 15px;">
                        <i class="fas fa-trash"></i> Remove All Files
                    </button>
                </div>
            </div>
            <input type="file" id="file-input" webkitdirectory multiple hidden disabled>
            <button id="toggle-files" class="btn btn-secondary">Hide All Files</button>
            <div id="creator-display" style="display: none;">Creator: <span id="creator-name-display"></span></div>
            
            <div id="file-tree" class="file-tree file-tree-container">
                <!-- File tree will be rendered here -->
            </div>

            <div class="untagged-items-container">
                <h4>Untagged Items:</h4>
                <ul id="untagged-items-list"></ul>
                <div id="all-tagged-message" style="display: none;">All Folder/File Tagged, Please Proceed to Generate Meta Data File.</div>
                
                <h4>(Step 4) Select Target Folder in Globus:</h4>
                <div class="globus-path-container">
                    <label for="globus-path">Select the folder where you uploaded your files in the 2025MADEPUBLICsnapshot directory:</label>
                    <select id="globus-path" class="form-control">
                        <option value="">-- Select Target Folder --</option>
                        <option value="Thrust 1/">Thrust 1</option>
                        <option value="Thrust 2/">Thrust 2</option>
                        <option value="Thrust 3/">Thrust 3</option>
                        <option value="Thrust 4/">Thrust 4</option>
                        <option value="Thrust 5/">Thrust 5</option>
                        <option value="General/">General</option>
                        <option value="Publication Records/">Publication Records</option>
                    </select>
                </div>
                <button id="generate-metadata" class="btn btn-primary btn-block">(Step 5) Generate Metadata JSON File</button>
            </div>
            
            <div class="json-upload-instruction">
                <h4>(Step 6) Automated Ingest to Search Index:</h4>
                <button id="auto-ingest" class="btn btn-success btn-block" style="display:none;">Automatically Ingest to Search Index</button>
                <div id="ingest-status" class="alert" style="display:none;"></div>
            </div>
        </div>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script>
        $(document).ready(function() {
            // Make sections collapsible
            $('.section h4').click(function() {
                $(this).parent('.section').toggleClass('collapsed');
            });
            
            const fileInput = document.getElementById('file-input');
            const fileTreeContainer = document.getElementById('file-tree');
            const dropZone = document.getElementById('file-drop-zone');
            let showFiles = true;
            let lastSelectedItem = null;
            let fileTags = {};
            let foldersCollapsed = {};
            let allLoadedFiles = [];  // Store ALL files loaded across multiple operations

            // Simple folder selection - no dialog needed
            fileInput.addEventListener('change', handleFileUpload);

            function handleFileUpload(e) {
                const files = Array.from(e.target.files);
                // Add to existing files instead of replacing
                addFilesToCollection(files);
            }

            function addFilesToCollection(newFiles) {
                // Add new files to the collection
                allLoadedFiles = allLoadedFiles.concat(newFiles);
                // Update file count display
                if (allLoadedFiles.length > 0) {
                    $('#file-count').show();
                    $('#file-count-text').text(`${allLoadedFiles.length} file${allLoadedFiles.length > 1 ? 's' : ''} loaded`);
                }
                // Display all files (accumulated)
                displayFileStructure(allLoadedFiles, false);
            }

            // Enable/disable drop zone based on creator confirmation
            $('#confirm-creator').click(function() {
                var creatorName = $('#creator-name').val().trim();
                if (creatorName) {
                    $('#creator-name-display').text(creatorName);
                    $('#creator-display').show();
                    $('#file-input').prop('disabled', false);
                    $('#file-input-label').removeClass('disabled');
                    dropZone.style.opacity = '1';
                    dropZone.style.pointerEvents = 'auto';
                } else {
                    $('#creator-display').hide();
                    $('#file-input').prop('disabled', true);
                    $('#file-input-label').addClass('disabled');
                    dropZone.style.opacity = '0.5';
                    dropZone.style.pointerEvents = 'none';
                }
            });

            // Initially disable drop zone
            dropZone.style.opacity = '0.5';
            dropZone.style.pointerEvents = 'none';

            // Drag and drop functionality
            dropZone.addEventListener('dragover', function(e) {
                e.preventDefault();
                e.stopPropagation();
                this.style.backgroundColor = '#e7f3ff';
                this.style.borderColor = '#0056b3';
            });

            dropZone.addEventListener('dragleave', function(e) {
                e.preventDefault();
                e.stopPropagation();
                this.style.backgroundColor = '#f8f9fa';
                this.style.borderColor = '#007bff';
            });

            dropZone.addEventListener('drop', async function(e) {
                e.preventDefault();
                e.stopPropagation();
                this.style.backgroundColor = '#f8f9fa';
                this.style.borderColor = '#007bff';
                
                if ($('#file-input').prop('disabled')) {
                    alert('Please enter creator name first');
                    return;
                }

                const items = e.dataTransfer.items;
                const allDroppedFiles = [];
                const promises = [];
                
                // Process all dropped items
                for (let i = 0; i < items.length; i++) {
                    const item = items[i].webkitGetAsEntry();
                    if (item) {
                        promises.push(new Promise((resolve) => {
                            traverseFileTree(item, '', function(files) {
                                allDroppedFiles.push(...files);
                                resolve();
                            });
                        }));
                    }
                }
                
                // Wait for all files to be processed
                await Promise.all(promises);
                
                // Add all dropped files to the collection
                addFilesToCollection(allDroppedFiles);
            });

            // Helper function to traverse file tree from drag and drop
            function traverseFileTree(item, path, callback) {
                const files = [];
                let pending = 0;
                
                function checkComplete() {
                    pending--;
                    if (pending === 0) {
                        callback(files);
                    }
                }
                
                if (item.isFile) {
                    pending++;
                    item.file(function(file) {
                        // Add webkitRelativePath property
                        Object.defineProperty(file, 'webkitRelativePath', {
                            value: path + file.name,
                            writable: false
                        });
                        files.push(file);
                        checkComplete();
                    });
                } else if (item.isDirectory) {
                    pending++;
                    const dirReader = item.createReader();
                    dirReader.readEntries(function(entries) {
                        for (let i = 0; i < entries.length; i++) {
                            pending++;
                            traverseFileTree(entries[i], path + item.name + '/', function(subFiles) {
                                files.push(...subFiles);
                                checkComplete();
                            });
                        }
                        checkComplete();
                    });
                }
            }

            function displayFileStructure(files, isFileMode) {
                let fileMap = {};
                
                // Process all files into the map
                for (let file of files) {
                    let paths = file.webkitRelativePath ? file.webkitRelativePath.split('/') : [file.name];
                    let currentPath = '';
                    
                    paths.forEach((path, index) => {
                        if (index > 0) currentPath += '/';
                        currentPath += path;
                        
                        if (!fileMap[currentPath]) {
                            let isFile = index === paths.length - 1;
                            let documentType = isFile ? (path.includes('.') ? path.split('.').pop() : 'Others') : 'Folder';
                            const tagData = fileTags[currentPath];
                            fileMap[currentPath] = {
                                path: currentPath,
                                children: [],
                                isFile: isFile,
                                depth: index,
                                tag: tagData ? tagData.raw : '',
                                tagData: tagData || null,
                                documentType: documentType,
                                name: path
                            };
                        }
                        
                        // Add to parent's children if not root
                        if (index > 0) {
                            const parentPath = paths.slice(0, index).join('/');
                            if (fileMap[parentPath] && !fileMap[parentPath].children.includes(currentPath)) {
                                fileMap[parentPath].children.push(currentPath);
                            }
                        }
                    });
                }

                // Clear and rebuild the tree
                fileTreeContainer.innerHTML = '';
                
                // Find all root items (items with no parent in the map)
                const rootItems = [];
                for (let path in fileMap) {
                    const item = fileMap[path];
                    // Check if this is a root item (no parent exists in the map)
                    const parentPath = path.includes('/') ? path.substring(0, path.lastIndexOf('/')) : null;
                    if (!parentPath || !fileMap[parentPath]) {
                        rootItems.push(item);
                    }
                }
                
                // Display all root items
                let html = '';
                rootItems.forEach(rootItem => {
                    html += createTreeHtml(fileMap, rootItem, 0);
                });
                fileTreeContainer.innerHTML = html;

                bindClickEvents();
                bindRemoveButtons();
                bindTagButtons();
                updateUntaggedItemsList();
            }

            function bindTagButtons() {
                // Handle show all tags button
                $('.show-all-tags').off('click').on('click', function(e) {
                    e.stopPropagation();
                    e.preventDefault();
                    const tagId = $(this).data('tag-id');
                    const detailDiv = $(`#tags-${tagId}`);
                    
                    if (detailDiv.is(':visible')) {
                        detailDiv.slideUp(200);
                        $(this).html('<i class="fas fa-chevron-down"></i> Show all');
                    } else {
                        detailDiv.slideDown(200);
                        $(this).html('<i class="fas fa-chevron-up"></i> Hide');
                    }
                });
            }

            function bindRemoveButtons() {
                // Remove individual file/folder
                $('.remove-file').click(function(e) {
                    e.stopPropagation();
                    const pathToRemove = $(this).data('path');
                    
                    // Remove from allLoadedFiles
                    allLoadedFiles = allLoadedFiles.filter(file => {
                        const filePath = file.webkitRelativePath || file.name;
                        // Remove if it matches exactly or is a child of the path
                        return !filePath.startsWith(pathToRemove);
                    });
                    
                    // Remove tags for this path
                    delete fileTags[pathToRemove];
                    
                    // Update display
                    if (allLoadedFiles.length > 0) {
                        $('#file-count-text').text(`${allLoadedFiles.length} file${allLoadedFiles.length > 1 ? 's' : ''} loaded`);
                        displayFileStructure(allLoadedFiles, false);
                    } else {
                        $('#file-count').hide();
                        fileTreeContainer.innerHTML = '';
                        updateUntaggedItemsList();
                    }
                });
                
                // Remove all files button
                $('#remove-all-files').off('click').on('click', function() {
                    if (confirm('Are you sure you want to remove all files?')) {
                        fileTreeContainer.innerHTML = '';
                        fileInput.value = '';
                        fileTags = {};
                        foldersCollapsed = {};
                        allLoadedFiles = [];
                        generatedJsonData = null;
                        $('#auto-ingest').hide();
                        $('#ingest-status').hide();
                        $('#file-count').hide();
                        updateUntaggedItemsList();
                    }
                });
            }

            function bindClickEvents() {
                $('.file-tree li').click(function(e) {
                    // Don't handle clicks on buttons
                    if ($(e.target).closest('button').length > 0) {
                        return;
                    }
                    e.stopPropagation();
                    const $this = $(this);
                    const isFolder = !$this.hasClass('file');
                    const path = $this.data('path');

                    if (isFolder) {
                        if (!e.shiftKey && !e.ctrlKey) {
                            $('body').removeClass('no-select');
                            $('.file-tree li').removeClass('selected');
                            $this.addClass('selected');
                            lastSelectedItem = $this;
                        }

                        if (e.ctrlKey) {
                            $this.toggleClass('selected');
                        } else {
                            toggleFolder($this, path);
                        }
                    } else {
                        if (e.shiftKey) {
                            $('body').addClass('no-select');
                            handleShiftSelection($this);
                        } else if (e.ctrlKey) {
                            $this.toggleClass('selected');
                        } else {
                            $('body').removeClass('no-select');
                            $('.file-tree li').removeClass('selected');
                            $this.addClass('selected');
                            lastSelectedItem = $this;
                        }
                    }
                });
            }

            function toggleFolder($folder, path) {
                foldersCollapsed[path] = !foldersCollapsed[path];
                const isCollapsed = foldersCollapsed[path];
                const $childrenUl = $folder.next('ul');
                if ($childrenUl.length) {
                    $childrenUl.toggle(!isCollapsed);
                }
                $folder.find('> .file-icon').toggleClass('fa-folder', isCollapsed).toggleClass('fa-folder-open', !isCollapsed);
            }

            function handleShiftSelection(currentItem) {
                if (!lastSelectedItem) {
                    currentItem.addClass('selected');
                    lastSelectedItem = currentItem;
                    return;
                }

                const allItems = $('.file-tree li:not(.folder)');
                const currentIndex = allItems.index(currentItem);
                const lastIndex = allItems.index(lastSelectedItem);

                if (currentIndex > lastIndex) {
                    allItems.slice(lastIndex, currentIndex + 1).addClass('selected');
                } else {
                    allItems.slice(currentIndex, lastIndex + 1).addClass('selected');
                }
            }

            function createTreeHtml(fileMap, node, level) {
                if (!node) return '';
                const displayName = node.name || node.path.split('/').pop();
                let html = `<li class="${node.isFile ? 'file' : 'folder'} ${node.tag ? 'tagged' : 'untagged'}" data-path="${node.path}" data-level="${level}" style="margin-left: ${level * 20}px; position: relative;">`;
                
                // First row: File icon, name, document type, and remove button
                html += `<div style="display: flex; align-items: center; width: 100%;">`;
                html += `<span class="file-icon ${node.isFile ? 'fas fa-file' : foldersCollapsed[node.path] ? 'fas fa-folder' : 'fas fa-folder-open'} ${node.tag ? 'tagged' : 'untagged'}" style="margin-right: 8px;"></span>`;
                html += `<span class="file-name" title="${node.path}" style="font-weight: 500; margin-right: 8px;">${displayName}</span>`;
                html += `<span class="tag document-type-tag" style="margin-right: 8px;">${node.documentType}</span>`;
                if (!node.isFile && node.children.length > 0) {
                    html += `<button class="toggle-folder btn btn-sm btn-secondary" style="margin-right: 5px;">Toggle</button>`;
                }
                html += `<button class="remove-file btn btn-danger btn-sm" data-path="${node.path}" style="margin-left: auto;" title="Remove this item">
                    <i class="fas fa-times"></i>
                </button>`;
                html += `</div>`;
                
                // Second row: Tags (if any) - displayed below the file name
                if (node.tagData && node.tag !== "[, , , , ]") {
                    html += `<div class="file-tag" style="margin-top: 5px; margin-left: 28px;">`;
                    
                    // Create a detailed tag list
                    let allTags = [];
                    const categories = node.tagData.categories;
                    
                    if (categories) {
                        if (categories[0]) allTags.push(`Thrust: ${categories[0]}`);
                        if (categories[1]) allTags.push(`PI: ${categories[1]}`);
                        if (categories[2]) allTags.push(`Topics: ${categories[2]}`);
                        if (categories[3]) allTags.push(`Data Tags: ${categories[3]}`);
                        if (categories[4]) allTags.push(`Data Type: ${categories[4]}`);
                    }
                    if (node.tagData.abstract) allTags.push('Has Abstract');
                    if (node.tagData.link) allTags.push('Has Link');
                    
                    // Show compact view with expandable details
                    html += `<div style="display: flex; flex-wrap: wrap; gap: 3px; align-items: center;">`;
                    
                    // Always show thrust
                    if (categories && categories[0]) {
                        html += `<span class="tag thrust-tag" style="font-size: 0.75rem;">${categories[0]}</span>`;
                    }
                    
                    // Show first PI if exists
                    if (categories && categories[1]) {
                        const firstPI = categories[1].split(',')[0].trim();
                        if (firstPI) {
                            html += `<span class="tag pi-tag" style="font-size: 0.75rem;">${firstPI}</span>`;
                        }
                    }
                    
                    // Expandable button for all tags
                    const tagId = node.path.replace(/[^a-zA-Z0-9]/g, '_');
                    html += `<button class="btn btn-sm btn-link show-all-tags" data-tag-id="${tagId}" style="padding: 0 5px; font-size: 0.75rem;">
                        <i class="fas fa-chevron-down"></i> Show all
                    </button>`;
                    html += `</div>`;
                    
                    // Hidden full tag list
                    html += `<div id="tags-${tagId}" class="all-tags-detail" style="display: none; margin-top: 5px; padding: 5px; background: #fff; border: 1px solid #ddd; border-radius: 3px; font-size: 0.8rem;">`;
                    allTags.forEach(tag => {
                        html += `<div style="margin: 2px 0;">• ${tag}</div>`;
                    });
                    html += `</div>`;
                    
                    html += `</div>`;
                }
                
                html += `</li>`;

                if (node.children.length > 0 && !node.isFile) {
                    const isCollapsed = foldersCollapsed[node.path];
                    html += '<ul style="list-style: none; padding-left: 0; display: ' + (isCollapsed ? 'none' : 'block') + ';">';
                    node.children.forEach(childPath => {
                        html += createTreeHtml(fileMap, fileMap[childPath], level + 1);
                    });
                    html += '</ul>';
                }

                return html;
            }

            // Removed "Others" checkbox handler for Thrust tags as we now have fixed 7 options

            $('#pi-tags input[name="pi-tag"]').change(function() {
                const othersChecked = $('#pi-tags input[name="pi-tag"][value="Others"]').is(':checked');
                $('#pi-other').toggle(othersChecked);
            });

            $('#topic-tags input[name="topic-tag"]').change(function() {
                const othersChecked = $('#topic-tags input[name="topic-tag"][value="Others"]').is(':checked');
                $('#topic-other').toggle(othersChecked);
            });

            $('#data-tags input[name="data-tag"]').change(function() {
                const othersChecked = $('#data-tags input[name="data-tag"][value="Others"]').is(':checked');
                $('#data-tag-other').toggle(othersChecked);
            });

            $('#data-type-tags input[name="data-type-tag"]').change(function() {
                const othersChecked = $('#data-type-tags input[name="data-type-tag"][value="Others"]').is(':checked');
                $('#data-type-other').toggle(othersChecked);
            });

            // Apply tags
            $('#apply-tag').click(function() {
                const subfolderFileCover = $('#subfolder-file-cover').is(':checked');
                const abstractDescription = $('#abstract-description').val();
                const outerLink = $('#outer-link').val();

                $('.file-tree li.selected').each(function() {
                    const path = $(this).data('path');

                    const thrustTags = $('#thrust-tags input[name="thrust-tag"]:checked').map(function() {
                        return this.value;
                    }).get().filter(value => value).join(', ');

                    const piTags = $('#pi-tags input[name="pi-tag"]:checked').map(function() {
                        return this.value === "Others" ? $('#pi-other').val() : this.value;
                    }).get().filter(value => value).join(', ');

                    const topicTags = $('#topic-tags input[name="topic-tag"]:checked').map(function() {
                        return this.value === "Others" ? $('#topic-other').val() : this.value;
                    }).get().filter(value => value).join(', ');

                    const dataTags = $('#data-tags input[name="data-tag"]:checked').map(function() {
                        return this.value === "Others" ? $('#data-tag-other').val() : this.value;
                    }).get().filter(value => value).join(', ');

                    const dataTypeTags = $('#data-type-tags input[name="data-type-tag"]:checked').map(function() {
                        return this.value === "Others" ? $('#data-type-other').val() : this.value;
                    }).get().filter(value => value).join(', ');

                    const tag = `[${thrustTags}, ${piTags}, ${topicTags}, ${dataTags}, ${dataTypeTags}]`;

                    if (tag !== "[, , , , ]") {
                        applyTagToItem(this, path, tag, [thrustTags, piTags, topicTags, dataTags, dataTypeTags], abstractDescription, outerLink);

                        if (subfolderFileCover && !$(this).hasClass('file')) {
                            applyTagToSubfoldersAndFiles(path, tag, [thrustTags, piTags, topicTags, dataTags, dataTypeTags], abstractDescription, outerLink);
                        }
                    } else {
                        applyTagToItem(this, path, tag, [thrustTags, piTags, topicTags, dataTags, dataTypeTags]);
                    }
                });
            });

            function applyTagToItem(item, path, tag, tagCategories, abstractDescription, outerLink) {
                // Store the raw tag data for later use in JSON generation
                fileTags[path] = {
                    raw: tag,
                    categories: tagCategories,
                    abstract: abstractDescription,
                    link: outerLink
                };
                
                // Update the visual state
                if (tag !== "[, , , , ]" && tagCategories.join('').trim() !== '') {
                    $(item).removeClass('untagged').addClass('tagged');
                    $(item).find('.file-icon').removeClass('untagged').addClass('tagged');
                } else {
                    $(item).removeClass('tagged').addClass('untagged');
                    $(item).find('.file-icon').removeClass('tagged').addClass('untagged');
                }
                
                // Refresh the display to show updated tags
                displayFileStructure(allLoadedFiles, false);
                updateUntaggedItemsList();
            }

            function applyTagToSubfoldersAndFiles(path, tag, tagCategories, abstractDescription, outerLink) {
                $('.file-tree li').filter(function() {
                    const itemPath = $(this).data('path');
                    return itemPath.startsWith(path) && itemPath !== path;
                }).each(function() {
                    const itemPath = $(this).data('path');
                    applyTagToItem(this, itemPath, tag, tagCategories, abstractDescription, outerLink);
                });
            }

            function updateUntaggedItemsList() {
                const untaggedItemsList = $('#untagged-items-list');
                untaggedItemsList.empty();

                $('.file-tree li.untagged').each(function() {
                    const itemName = $(this).find('.file-name').text();
                    untaggedItemsList.append(`<li>${itemName}</li>`);
                });

                if ($('.file-tree li.untagged').length === 0) {
                    $('#all-tagged-message').show();
                } else {
                    $('#all-tagged-message').hide();
                }
            }

            // Store the generated JSON data globally for auto-ingest
            let generatedJsonData = null;

            // Generate metadata JSON
            function generateMetadataJSON() {
                const globusPath = $('#globus-path').val();
                const creatorName = $('#creator-name').val().trim();
                const currentDate = new Date().toISOString().slice(0, 16).replace('T', ' ');
                const baseGlobusPath = 'globus://af7bda53-6d04-11e5-ba46-22000b92c6ec/project2/chenyuxin/2025MADEPUBLICsnapshot/';
                const jsonData = {
                    ingest_type: "GMetaList",
                    ingest_data: {
                        gmeta: []
                    }
                };

                $('.file-tree li.tagged').each(function() {
                    const path = $(this).data('path');
                    const pathParts = path.split('/');
                    const fileName = pathParts.pop();
                    const fileExtension = fileName.includes('.') ? fileName.split('.').pop() : 'Folder';
                    const folderName = pathParts.pop();
                    const parentFolder = pathParts.pop() || '';

                    const $tagSpans = $(this).find('.file-tag .tag');
                    const thrustTag = $tagSpans.filter('.thrust-tag').map(function() { return $(this).text(); }).get()[0];
                    const piTags = $tagSpans.filter('.pi-tag').map(function() { return $(this).text(); }).get().join(',');
                    const topicTags = $tagSpans.filter('.topic-tag').map(function() { return $(this).text(); }).get().sort().join(',');
                    const dataTags = $tagSpans.filter('.data-tag').map(function() { return $(this).text(); }).get().sort().join(',');
                    const dataTypeTags = $tagSpans.filter('.data-type-tag').map(function() { return $(this).text(); }).get().sort().join(',');
                    const abstractDescription = $(this).find('.abstract-tag').attr('title') || '';
                    const outerLink = $(this).find('.link-tag').attr('title') || '';

                    const idDate = currentDate.replace(/ /g, 'T');
                    const gmetaId = `${thrustTag}-${globusPath}-${parentFolder}-${folderName}-${fileName}-${thrustTag}-${creatorName}-${piTags}${idDate}`;
                    // Properly combine the base path with globus folder and file path
                    const fullPath = globusPath ? `${globusPath}${path}` : path;
                    const encodedSubject = `${baseGlobusPath}${encodeURI(fullPath)}`;
                    const rawUrl = `${baseGlobusPath}${fullPath}`;

                    const gmetaEntry = {
                        id: gmetaId,
                        subject: encodedSubject,
                        visible_to: ["urn:globus:groups:id:bb420e57-7835-11ee-b0db-d9a5237cb2e9"],
                        content: {
                            Title: fileName,
                            "Document Format": fileExtension,
                            "Abstract Description": abstractDescription,
                            "Data Type": dataTypeTags.split(','),
                            "Outer Link": outerLink,
                            url: rawUrl,
                            creator: creatorName,
                            "Related Topic": topicTags.split(','),
                            "PI Affiliated": piTags.split(','),
                            "Data Tags": dataTags.split(','),
                            Thrust: thrustTag,
                            date: currentDate.replace(/ /g, 'T'),
                            "original_collection_name": "UChicago RCC Midway"
                        }
                    };

                    jsonData.ingest_data.gmeta.push(gmetaEntry);
                });

                // Store the generated JSON data for auto-ingest
                generatedJsonData = jsonData;
                
                // Show the auto-ingest button
                $('#auto-ingest').show();
                
                downloadJSONFile(jsonData, `${creatorName}_${globusPath.split('/').pop()}_${currentDate.replace(/:/g, '_').replace(/ /g, 'T')}.json`);
            }

            function downloadJSONFile(jsonData, fileName) {
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(jsonData, null, 2));
                const downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute("href", dataStr);
                downloadAnchorNode.setAttribute("download", fileName);
                document.body.appendChild(downloadAnchorNode);
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
            }

            $('#generate-metadata').click(function() {
                // Check if all items are tagged
                const untaggedItems = $('.file-tree li.untagged');
                if (untaggedItems.length > 0) {
                    alert(`Cannot generate metadata! You have ${untaggedItems.length} untagged item(s). Please tag all files and folders before generating metadata.`);
                    return;
                }
                generateMetadataJSON();
            });

            // Auto-ingest button handler
            $('#auto-ingest').click(function() {
                if (!generatedJsonData) {
                    alert('Please generate metadata first');
                    return;
                }
                
                const $button = $(this);
                const $status = $('#ingest-status');
                
                // Disable button and show loading
                $button.prop('disabled', true).text('Ingesting...');
                $status.removeClass('alert-success alert-danger').addClass('alert-info').text('Sending data to search index...').show();
                
                // Send the JSON data to the backend for ingestion
                $.ajax({
                    url: '/auto_ingest_metadata/',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(generatedJsonData),
                    success: function(response) {
                        if (response.success) {
                            $status.removeClass('alert-info alert-danger').addClass('alert-success');
                            $status.html(`
                                <strong>Success!</strong> ${response.message}<br>
                                <small>Index UUID: ${response.index_uuid}</small><br>
                                <small>Task ID: ${response.task_id}</small><br>
                                <br>
                                <strong>Next steps:</strong><br>
                                1. The data has been ingested to the search index<br>
                                2. It may take a few moments to appear in search results<br>
                                3. You can now search for your data in the Repository
                            `);
                            $button.text('Successfully Ingested!').removeClass('btn-success').addClass('btn-secondary');
                        } else {
                            $status.removeClass('alert-info alert-success').addClass('alert-danger');
                            $status.html(`<strong>Warning:</strong> ${response.message}`);
                            $button.prop('disabled', false).text('Retry Auto-Ingest');
                        }
                    },
                    error: function(xhr, status, error) {
                        $status.removeClass('alert-info alert-success').addClass('alert-danger');
                        let errorMsg = 'Failed to ingest metadata.';
                        if (xhr.responseJSON && xhr.responseJSON.message) {
                            errorMsg += ' ' + xhr.responseJSON.message;
                        } else {
                            errorMsg += ' ' + error;
                        }
                        $status.html(`<strong>Error:</strong> ${errorMsg}`);
                        $button.prop('disabled', false).text('Retry Auto-Ingest');
                    }
                });
            });

            // Clear and reset functions
            $('#clear-all').click(function() {
                fileTreeContainer.innerHTML = '';
                fileInput.value = '';
                fileTags = {};
                foldersCollapsed = {};
                allLoadedFiles = [];  // Clear accumulated files
                generatedJsonData = null;  // Clear generated JSON
                $('#auto-ingest').hide();  // Hide ingest button
                $('#ingest-status').hide();  // Hide status
                $('#file-count').hide();  // Hide file count
                $('body').removeClass('no-select');
                $('.file-tree li').removeClass('selected');
            });

            $('#clear-selected-tags').click(function() {
                $('.file-tree li.selected').each(function() {
                    const path = $(this).data('path');
                    $(this).find('.file-tag').empty();
                    $(this).removeClass('tagged').addClass('untagged');
                    $(this).find('.file-icon').removeClass('tagged').addClass('untagged');
                    delete fileTags[path];
                });
                updateUntaggedItemsList();
            });

            $('#clear-tags').click(function() {
                $('.file-tree li').each(function() {
                    const path = $(this).data('path');
                    $(this).find('.file-tag').empty();
                    $(this).removeClass('tagged').addClass('untagged');
                    $(this).find('.file-icon').removeClass('tagged').addClass('untagged');
                    delete fileTags[path];
                });
                updateUntaggedItemsList();
            });

            // Confirm creator handler moved up to work with drop zone

            $('#deselect-all').click(function() {
                $('.file-tree li').removeClass('selected');
            });

            $('#toggle-files').click(function() {
                showFiles = !showFiles;
                $(this).text(showFiles ? 'Hide All Files' : 'Show All Files');

                $('.folder').each(function() {
                    const path = $(this).data('path');
                    foldersCollapsed[path] = !showFiles;
                    const $childrenUl = $(this).next('ul');
                    if ($childrenUl.length) {
                        $childrenUl.toggle(showFiles);
                    }
                    $(this).find('.file-icon').toggleClass('fa-folder', !showFiles).toggleClass('fa-folder-open', showFiles);
                });
            });

            $(document).on('mouseup keyup', function(e) {
                if (e.type === 'mouseup' || e.keyCode === 16) {
                    $('body').removeClass('no-select');
                }
            }).on('keydown', function(e) {
                if (e.keyCode === 16) {
                    $('body').addClass('no-select');
                }
            });

            $('.file-tree-container').on('click', '.toggle-folder', function() {
                const path = $(this).data('path');
                const $folder = $(`.file-tree li[data-path="${path}"]`);
                toggleFolder($folder, path);
            });
        });
    </script>
</body>
</html>

{% endblock %}
