{# myportal/templates/globus-portal-framework/v2/components/search-results.html #}

<!-- Import enhanced CSS -->
<link rel="stylesheet" type="text/css" href="{% load static %}{% static 'css/search-enhanced.css' %}" />

<!-- Font Awesome for icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">


<!-- Move the sticky section to wrap only what needs to be sticky in the right column -->
<!-- This search bar will be above both columns -->
<div class="search-bar-top">
    <form id="search-form-sticky" class="search-form-enhanced" name="search_form" action="{% url 'search' globus_portal_framework.index %}">
        <input type="text" id="search-input-sticky" class="search-input-enhanced" autocomplete="off"
               data-provide="typeahead" name="q"
               value="{{request.session.search.query}}" placeholder="Start your search here">
        <button id="search-btn-sticky" type="submit" class="btn btn-search">
            <i class="fas fa-search"></i>
        </button>
    </form>
</div>

<!-- Sticky Top Section for toolbar only -->
<div class="sticky-top-section">
    <!-- Enhanced Action Toolbar - All in One Line -->
    <div class="search-action-toolbar">
    <div class="toolbar-single-row">
        <button id="add-to-list-btn" class="toolbar-btn btn-primary-action">
            <i class="fas fa-plus-circle"></i>
            Add Current Page
        </button>
        <button id="preview-list-btn" class="toolbar-btn btn-secondary-action">
            <i class="fas fa-eye"></i>
            Preview
        </button>
        <button id="save-search-btn" class="toolbar-btn btn-info-action">
            <i class="fas fa-download"></i>
            Download
        </button>
        <button id="graph-visualization-btn" class="toolbar-btn btn-secondary-action">
            <i class="fas fa-project-diagram"></i>
            Graph
        </button>
        <button id="clear-all-btn" class="toolbar-btn btn-danger-action">
            <i class="fas fa-trash-alt"></i>
            Clear
        </button>
        
        <div class="divider-vertical"></div>
        
        <div class="item-counter">
            <i class="fas fa-list"></i>
            <span>List:</span>
            <span class="counter-number" id="total-items">0</span>
        </div>
        
        <div class="results-info">
            <i class="fas fa-info-circle"></i>
            <span>Page: <strong>{{ search.count }}</strong></span>
        </div>
    </div>
    
    <div class="performance-warning">
        <i class="fas fa-exclamation-triangle"></i>
        <span><strong>Performance Note:</strong> For optimal graph visualization, select <strong>30 items or fewer</strong>. Larger datasets may significantly increase processing time.</span>
    </div>
</div>

    <!-- Pagination in Toolbar -->
    <div class="pagination-toolbar">
        <nav aria-label="Search Results Pages">
            <ul class="pagination pagination-compact">
                {% for page in search.pagination.pages %}
                {% if page.number == search.pagination.current_page %}
                <li class="page-item active">
                    <span class="page-link">{{page.number}}</span>
                </li>
                {% else %}
                <li class="page-item">
                    <a class="page-link" href="#" onclick="customSearch({{page.number}}); return false;">{{page.number}}</a>
                </li>
                {% endif %}
                {% endfor %}
            </ul>
        </nav>
    </div>
</div> <!-- End of sticky-top-section -->

<!-- Enhanced Preview Modal -->
<div class="preview-modal-overlay" id="preview-overlay"></div>
<div class="preview-modal" id="preview-box">
    <div class="preview-modal-header">
        <h2><i class="fas fa-list-ul"></i> Preview of Added Items</h2>
        <button class="close-modal close-preview">
            <i class="fas fa-times"></i>
        </button>
    </div>
    <div class="preview-modal-body">
        <ul id="preview-list" style="list-style: none; padding: 0;"></ul>
    </div>
</div>

<!-- Toast Container for Notifications -->
<div class="toast-container" id="toast-container"></div>

<!-- Enhanced Search Results Cards -->
<div class="search-results-container">
  {% for result in search.search_results %}
  <div class="search-result-card" data-index="{{ forloop.counter0 }}">
    <div class="card-header-enhanced">
      <div class="card-header-top">
        <h3 class="search-result-title">
          <a href="{% url 'detail' globus_portal_framework.index result.subject %}">
            <i class="fas fa-file-alt"></i> {{result.title|default:'Result'}}
          </a>
        </h3>
        <div class="card-actions">
          <button class="btn-card-action btn-add-entry add-entry-btn" data-index="{{ forloop.counter0 }}">
            <i class="fas fa-plus"></i> Add to List
          </button>
          <div class="abstract-container">
            <button class="btn-card-action abstract-btn">
              <i class="fas fa-info-circle"></i> Abstract
            </button>
            <div class="abstract-tooltip abstract-content">
              {{ result.abstract_description|default:"No abstract available" }}
            </div>
          </div>
          {% if result.outer_link %}
          <a href="{{ result.outer_link }}" class="btn-card-action btn-external-link" target="_blank">
            <i class="fas fa-external-link-alt"></i> External Link
          </a>
          {% endif %}
        </div>
      </div>
      
      <div class="card-metadata">
        {% if result.document_format %}
        <span class="metadata-tag tag-document">
          <i class="fas fa-file"></i> {{ result.document_format }}
        </span>
        {% endif %}
        {% if result.data_type %}
        <span class="metadata-tag tag-datatype">
          <i class="fas fa-database"></i> {{ result.data_type }}
        </span>
        {% endif %}
      </div>
    </div>
    
    <div class="card-body">
      {% if result.search_highlights %}
      <table class="table table-sm borderless">
        <tbody>
          <tr>
            {% for item in result.search_highlights %}
            <th style="color: #6c757d; font-weight: 500;">{{item.title}}</th>
            {% endfor %}
          </tr>
          <tr>
            {% for item in result.search_highlights %}
            {% if item.type == "date" %}
            <td>{{item.value | date:"DATETIME_FORMAT"}}</td>
            {% else %}
            <td>{{item.value}}</td>
            {% endif %}
            {% endfor %}
          </tr>
        </tbody>
      </table>
      {% endif %}
    </div>
  </div>
  {% endfor %}
</div>


{# 在 HTML 中使用 Django 的 json_script 标签将 search 对象注入页面 #}
{{ search.search_results|json_script:"search-data" }}

<script>
  document.addEventListener('DOMContentLoaded', function () {
    // Initialize or retrieve totalList from sessionStorage
    let totalList = JSON.parse(sessionStorage.getItem('totalList')) || [];
    const searchData = JSON.parse(document.getElementById('search-data').textContent);
    const totalItemsCount = document.getElementById('total-items');

    // Toast notification function
    function showToast(message, type = 'info') {
      const toastContainer = document.getElementById('toast-container');
      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;
      
      const icon = type === 'success' ? 'check-circle' : 
                   type === 'error' ? 'times-circle' : 
                   'info-circle';
      
      toast.innerHTML = `
        <i class="fas fa-${icon}"></i>
        <span>${message}</span>
      `;
      
      toastContainer.appendChild(toast);
      
      setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease-in';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    // Function to update the displayed total count
    function updateTotalCount() {
      totalItemsCount.textContent = totalList.length;
      // Animate the counter
      totalItemsCount.style.animation = 'none';
      setTimeout(() => {
        totalItemsCount.style.animation = 'pulse 0.5s ease';
      }, 10);
    }

    // Function to check for duplicate entries in the list
    function isDuplicate(entry) {
      return totalList.some(item => JSON.stringify(item) === JSON.stringify(entry));
    }

    // Update card visual state
    function updateCardStates() {
      document.querySelectorAll('.search-result-card').forEach((card, index) => {
        const entry = searchData[index];
        const addBtn = card.querySelector('.add-entry-btn');
        if (isDuplicate(entry)) {
          card.classList.add('selected');
          addBtn.innerHTML = '<i class="fas fa-check"></i> Added';
          addBtn.classList.add('added');
          addBtn.disabled = true;
        } else {
          card.classList.remove('selected');
          addBtn.innerHTML = '<i class="fas fa-plus"></i> Add to List';
          addBtn.classList.remove('added');
          addBtn.disabled = false;
        }
      });
    }

    // Add to List functionality
    document.getElementById('add-to-list-btn').addEventListener('click', function () {
      let addedCount = 0;
      searchData.forEach(entry => {
        if (!isDuplicate(entry)) {
          totalList.push(entry);
          addedCount++;
        }
      });
      sessionStorage.setItem('totalList', JSON.stringify(totalList));
      updateTotalCount();
      updateCardStates();
      
      if (addedCount > 0) {
        showToast(`Added ${addedCount} items to list`, 'success');
      } else {
        showToast('All items already in list', 'info');
      }
    });

    // Add single entry to the list when "Add this Entry to List" is clicked
    document.querySelectorAll('.add-entry-btn').forEach((button, index) => {
      button.addEventListener('click', function () {
        const entry = searchData[index];
        if (!isDuplicate(entry)) {
          totalList.push(entry);
          sessionStorage.setItem('totalList', JSON.stringify(totalList));
          updateTotalCount();
          updateCardStates();
          showToast('Item added to list', 'success');
        } else {
          showToast('This item is already in the list', 'info');
        }
      });
    });

    // Clear All Added functionality
    document.getElementById('clear-all-btn').addEventListener('click', function () {
      if (totalList.length > 0) {
        if (confirm('Are you sure you want to clear all items from the list?')) {
          totalList = [];
          sessionStorage.setItem('totalList', JSON.stringify(totalList));
          updateTotalCount();
          updateCardStates();
          showToast('List cleared successfully', 'success');
        }
      } else {
        showToast('List is already empty', 'info');
      }
    });

    // Download All functionality
    document.getElementById('save-search-btn').addEventListener('click', function () {
        const totalList = JSON.parse(sessionStorage.getItem('totalList')) || [];

        // Process the data using the same function as graph-visualization-btn
        fetch('/process_graph_data/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(totalList)
        })
        .then(response => response.json())
        .then(data => {
            // Create a Blob with the processed data
            const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = window.URL.createObjectURL(blob);
            link.download = 'processed_search_results.json';
            link.click();
            window.URL.revokeObjectURL(link.href);
        })
        .catch(error => console.error('Error:', error));
    });

    // Abstract button functionality
    document.querySelectorAll('.abstract-btn').forEach(function (button) {
      button.addEventListener('mouseover', function () {
        this.nextElementSibling.style.display = 'block';
      });
      button.addEventListener('mouseout', function () {
        this.nextElementSibling.style.display = 'none';
      });
    });


    document.getElementById('graph-visualization-btn').addEventListener('click', function () {
      const totalList = JSON.parse(sessionStorage.getItem('totalList')) || [];

      fetch('/process_graph_data/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(totalList)
      })
        .then(response => response.json())
        .then(data => {
          // Instead of redirecting with URL parameters, store the data in sessionStorage
          sessionStorage.setItem('graphVisualizationData', JSON.stringify(data));
          window.location.href = '/graph_visualization/';
        })
        .catch(error => console.error('Error:', error));
    });

    // Function to get CSRF token
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }



    // Preview List functionality
    const previewListBtn = document.getElementById('preview-list-btn');
    const previewBox = document.getElementById('preview-box');
    const previewOverlay = document.getElementById('preview-overlay');
    const previewList = document.getElementById('preview-list');
    const closePreview = document.querySelector('.close-preview');

    previewListBtn.addEventListener('click', function () {
      if (totalList.length === 0) {
        showToast('No items in list to preview', 'info');
        return;
      }
      
      // Show preview modal
      previewBox.style.display = 'block';
      previewOverlay.style.display = 'block';
      
      // Populate the preview list with enhanced styling
      previewList.innerHTML = '';
      totalList.forEach((item, index) => {
        const li = document.createElement('li');
        li.className = 'preview-item';
        
        let content = `<div class="preview-item-number">${index + 1}. ${item.title || 'Untitled'}</div>`;

        // Add metadata tags
        content += '<div class="card-metadata" style="margin: 10px 0;">';
        if (item.document_format) {
          content += `<span class="metadata-tag tag-document">
                        <i class="fas fa-file"></i> ${item.document_format}
                      </span>`;
        }
        if (item.data_type) {
          content += `<span class="metadata-tag tag-datatype">
                        <i class="fas fa-database"></i> ${item.data_type}
                      </span>`;
        }
        content += '</div>';

        // Add search highlights
        if (item.search_highlights && item.search_highlights.length > 0) {
          content += '<div style="margin-top: 10px; color: #6c757d;">';
          item.search_highlights.forEach(highlight => {
            content += `<div style="margin-bottom: 5px;">
                          <strong>${highlight.title}:</strong> `;
            if (highlight.type === "date") {
              content += new Date(highlight.value).toLocaleString();
            } else {
              content += highlight.value;
            }
            content += '</div>';
          });
          content += '</div>';
        }

        li.innerHTML = content;
        previewList.appendChild(li);
      });
    });

    // Close modal handlers
    closePreview.addEventListener('click', function () {
      previewBox.style.display = 'none';
      previewOverlay.style.display = 'none';
    });
    
    previewOverlay.addEventListener('click', function () {
      previewBox.style.display = 'none';
      previewOverlay.style.display = 'none';
    });
    
    // Initialize on page load
    updateTotalCount();
    updateCardStates();
  });
</script>